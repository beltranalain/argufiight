#!/usr/bin/env node
/**
 * Ensure Prisma RHEL binary exists and is in the correct location
 * This script runs after prisma generate to verify the binary is present
 */

import { existsSync, copyFileSync, mkdirSync } from 'fs'
import { join, resolve, dirname } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const rootDir = resolve(__dirname, '..')

const prismaClientDir = join(rootDir, 'node_modules', '.prisma', 'client')
const binaryName = 'libquery_engine-rhel-openssl-3.0.x.so.node'
const binaryPath = join(prismaClientDir, binaryName)

console.log('ðŸ” Checking for Prisma RHEL binary...')

if (!existsSync(prismaClientDir)) {
  console.error('âŒ Prisma client directory not found:', prismaClientDir)
  console.error('   Run: npx prisma generate')
  process.exit(1)
}

if (existsSync(binaryPath)) {
  console.log('âœ… Prisma RHEL binary found:', binaryPath)
  
  // Also check if it needs to be copied to .next directory
  const nextDir = join(rootDir, '.next', 'server', 'node_modules', '.prisma', 'client')
  if (existsSync(join(rootDir, '.next'))) {
    try {
      mkdirSync(nextDir, { recursive: true })
      const nextBinaryPath = join(nextDir, binaryName)
      copyFileSync(binaryPath, nextBinaryPath)
      console.log('âœ… Copied binary to .next directory:', nextBinaryPath)
    } catch (error) {
      console.warn('âš ï¸  Could not copy binary to .next (may not exist yet):', error.message)
    }
  }
} else {
  console.error('âŒ Prisma RHEL binary NOT found:', binaryPath)
  console.error('   The binary should be generated by: npx prisma generate')
  console.error('   Make sure schema.prisma has: binaryTargets = ["native", "rhel-openssl-3.0.x"]')
  
  // List what files are in the directory
  try {
    const { readdirSync } = await import('fs')
    const files = readdirSync(prismaClientDir)
    console.log('   Files in .prisma/client:', files.filter(f => f.includes('query_engine')))
  } catch (e) {
    // Ignore
  }
  
  process.exit(1)
}

console.log('âœ… Prisma binary check complete!')






